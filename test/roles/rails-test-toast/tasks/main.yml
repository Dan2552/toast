---
# Using Bundler to install and pick the right rails version for calling "rails new"
# (a temporary Gemfile is put into home and removed after)

- set_fact:
    rails_5: "{{ version.split('.')[0] == '5' }}"
    app_dir: rails_{{ '.'.join(version.split('.')[0:2]) }}-test
  tags: 
    - test

- name: Setup Gemfile for Rails install
  blockinfile:
    dest: ~/Gemfile
    create: yes
    block: |
      source 'https://rubygems.org'
      gem 'rails', '~> {{ version }}'
  become: yes
  become_user: vagrant

- name: bundle Rails
  bundler:
    user_install: no
    state: present
    chdir: ~
    executable: /usr/local/bin/bundle

- name: init rails app (v5)
  command: bundle exec rails new {{ app_dir }} --api --skip-spring
  args:
    chdir: /home/vagrant
    creates: /home/vagrant/{{ app_dir }}
  become: yes
  become_user: vagrant
  when: rails_5

- name: init rails app (v4)
  command: bundle exec rails new {{ app_dir }} --skip-javascript --skip-spring
  args:
    chdir: /home/vagrant
    creates: /home/vagrant/{{ app_dir }}
  become: yes
  become_user: vagrant
  when: not rails_5

- name: remove uglifier
  lineinfile: 
    path: /home/vagrant/{{ app_dir }}/Gemfile
    regexp: gem 'uglifier'
    state: absent
  become: yes
  become_user: vagrant  
  when: not rails_5

- name: bundle again
  command: bundle
  args:
    chdir: /home/vagrant/{{ app_dir }}
  become: yes
  become_user: vagrant
  when: not rails_5

- name: remove temporary Gemfile
  file:
    state: absent
    path: "{{ item }}"
  with_items:
    - Gemfile
    - Gemfile.lock

- name: link test suite
  shell: cp -rsf /vagrant/test/test-suite/* .
  args:
    chdir: /home/vagrant/{{ app_dir }}
  become: yes
  become_user: vagrant

- name: add development deps to Gemfile
  blockinfile:
    dest: /home/vagrant/{{ app_dir }}/Gemfile
    block: |
      group :development, :test do
        gem 'shoulda'
        gem 'pry'
        gem 'pry-byebug'
        gem 'pry-rails'
        gem 'minitest-reporters'
      end
      gem 'toast', path: '/vagrant'
  become: yes
  become_user: vagrant

- name: bundle test app
  bundler:
    state: present
    chdir: ~/{{ app_dir }}
  become: yes
  become_user: vagrant

- name: setup database tables
  command: bin/rake db:setup chdir=/home/vagrant/{{ app_dir }}
  become: yes
  become_user: vagrant

- command: bin/rails -v 
  register: final_version
  become: yes
  become_user: vagrant
  changed_when: false
  args:
    chdir: /home/vagrant/{{ app_dir }}
  tags:
    - test

- name: run toast test suite for {{ final_version.stdout }}
  command: bin/rake test chdir=/home/vagrant/{{ app_dir }}
  become: yes
  become_user: vagrant
  tags:
    - test
